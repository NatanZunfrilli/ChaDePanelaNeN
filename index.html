<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Presentes do Chá de Panela</title>
    <!-- 1. CARREGAR FONTE CUSTOMIZADA (Usando Great Vibes como substituto elegante para Riley) -->
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">
    <!-- Configuração e Carregamento do Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configuração customizada do Tailwind para definir a cor verde do usuário
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Paleta personalizada baseada em rgb(112, 145, 110)
                        'casamento': {
                            100: '#e6f0e6', // Muito claro (para fundos de alerta)
                            200: '#c5dac4', // Claro (para fundo de status reservado)
                            300: '#a3c3a2', // Sombra
                            500: '#70916e', // Base (A cor exata do usuário)
                            600: '#648262', // Botões e Modal BG
                            700: '#587356', // Hover e Textos Escuros
                            800: '#4c644a', // Texto mais escuro (status reservado)
                        },
                    },
                    // 2. Adicionar a fonte customizada ao Tailwind
                    fontFamily: {
                        'riley-substitute': ['"Great Vibes"', 'cursive'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Define a fonte Inter como padrão para o corpo, exceto onde especificado */
        :root {
            font-family: 'Inter', sans-serif;
        }
        /* Estilos de scrollbar simples */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            /* Cor do scrollbar combinando com a nova paleta */
            background-color: #a3c3a2; 
            border-radius: 4px;
        }
        .text-shadow-custom {
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }
        /* Cor de fundo suave (Fundo da página geral) */
        body {
            background-color: #fef2f2;
        }
        
        /* 3. Aumentar o tamanho da fonte no header para script fonts */
        .header-title {
            font-size: 2.75rem; /* Ajuste para ter um bom impacto visual com fonte script */
        }

        /* NOVO: Fundo do cabeçalho com o ícone (Placeholder) */
        .header-bg {
            /* A cor base ainda é a verde, mas adicionamos um fundo sutil do ícone */
            background-color: #70916e; 
            /* ATUALIZADO: Usando a imagem Icone.png do Canvas como background sutil */
            background-image: url('uploaded:Icone.png-a7b787e8-a81d-45a4-8e29-0a012a37c2b1'); 
            background-size: cover;
            background-position: center;
            background-blend-mode: multiply; /* Mistura a cor e a imagem de fundo */
        }


        /* Ajuste para mobile */
        @media (max-width: 640px) {
             .header-title {
                font-size: 2.25rem;
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col antialiased">

    <!-- Cabeçalho (Header) - AGORA USANDO A NOVA CLASSE DE FUNDO -->
    <header class="header-bg shadow-lg sticky top-0 z-10">
        <div class="max-w-4xl mx-auto p-4 flex justify-between items-center">
            <!-- 4. Aplicar a nova classe de fonte e classe de tamanho customizada -->
            <h1 class="header-title font-riley-substitute font-extrabold text-white text-shadow-custom">
                Lista de Presentes
            </h1>
            <div class="text-right">
                <!-- Ícone da Marca (Monograma N & N - Imagem real) -->
                <img src="./Images/Icone.png" alt="Logo do Casamento" class="w-28 h-28 object-cover border-2 border-white rounded-full p-1 shadow-lg bg-white" />
            </div>
        </div>
    </header>

    <!-- Seção Principal de Conteúdo -->
    <main class="flex-grow max-w-4xl mx-auto p-4 w-full">
        <!-- Mensagem de carregamento e erro - Cores atualizadas -->
        <div id="loading-status" class="text-center p-6 text-gray-600">
            Carregando lista de presentes...
        </div>
        <div id="error-message" class="hidden bg-casamento-100 border-l-4 border-casamento-500 text-casamento-700 p-4 mb-4" role="alert">
            <p class="font-bold">Erro de Conexão</p>
            <p id="error-text">Não foi possível carregar a lista. Verifique sua conexão.</p>
        </div>

        <!-- ID do Usuário (Obrigatório para multi-usuário) - Cores atualizadas -->
        <div class="mb-6 p-3 bg-casamento-100 text-casamento-700 rounded-lg shadow-inner">
            <p class="text-sm font-semibold">Seu ID de Sessão (Para fins de rastreio de reserva):</p>
            <p id="user-id-display" class="text-xs break-all mt-1 font-mono"></p>
        </div>
        
        <!-- Contêiner da Lista de Presentes -->
        <div id="gift-list-container" class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
            <!-- Os cartões de presente serão injetados aqui pelo JavaScript -->
        </div>

    </main>

    <!-- Modal de Reivindicação (Claiming Modal) - Cores atualizadas -->
    <div id="claim-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 transform transition-all duration-300 scale-95 opacity-0" id="modal-content">
            <h2 class="text-2xl font-bold mb-4 text-casamento-600" id="modal-title">Reivindicar Presente</h2>
            <p class="text-gray-700 mb-4">Você está prestes a reservar o item: <strong id="item-name-placeholder"></strong>.</p>

            <!-- NOVO: Container para as opções de imagem -->
            <div id="image-options-container" class="mb-4 p-3 border border-gray-200 rounded-lg bg-gray-50">
                <p class="text-sm font-semibold text-gray-700 mb-2">Opções de Estilo/Marca (Apenas Referência):</p>
                <!-- Galeria de imagens - MUDANÇA: Agora com grid-cols-3 para melhor visualização -->
                <div id="image-gallery" class="grid grid-cols-3 gap-2">
                    <!-- Imagens serão injetadas aqui -->
                </div>
            </div>
            <!-- Fim do NOVO Container -->

            <label for="claimant-name" class="block text-sm font-medium text-gray-700 mb-1">Seu Nome:</label>
            <input type="text" id="claimant-name" placeholder="Digite seu nome (ex: Maria)" required
                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-casamento-500 mb-4 transition duration-150">

            <div class="flex justify-end space-x-3">
                <button id="cancel-claim" type="button"
                        class="px-4 py-2 text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150 font-medium">
                    Cancelar
                </button>
                <button id="confirm-claim" type="button"
                        class="px-4 py-2 text-white bg-casamento-600 rounded-lg hover:bg-casamento-700 transition duration-150 font-semibold shadow-md shadow-casamento-300">
                    Confirmar Reserva
                </button>
            </div>
            <!-- Mensagem de erro do modal -->
            <p id="claim-error" class="hidden text-sm text-casamento-500 mt-3"></p>
        </div>
    </div>

    <!-- Firebase Imports e Scripts JS -->
    <script type="module">
        // Importa as funções essenciais do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // REMOVEMOS onAuthStateChanged pois usaremos signInAnonymously sequencialmente
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"; 
        import { getFirestore, collection, getDocs, doc, setDoc, getDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Ativar logs para depuração (opcional, mas útil)
        setLogLevel('Debug');

        // ==================================================================================
        // CREDENCIAIS DO FIREBASE FORNECIDAS PELO USUÁRIO (PROJETO: chadepanela-eeb39)
        // ==================================================================================
        const YOUR_FIREBASE_CONFIG = {
            apiKey: "AIzaSyAJbot5DSBGBRhXlBEcr4F_isF-_A4OjNU",
            authDomain: "chadepanela-eeb39.firebaseapp.com",
            projectId: "chadepanela-eeb39",
            storageBucket: "chadepanela-eeb39.firebasestorage.app",
            messagingSenderId: "399914997485",
            appId: "1:399914997485:web:3ebae86744dc9aec21dee4"
        };
        
        const firebaseConfig = YOUR_FIREBASE_CONFIG;
        // O appId é usado para criar o caminho da coleção (artifacts/{appId}/...)
        const appId = YOUR_FIREBASE_CONFIG.projectId; 
        
        // Variáveis do Firebase e do Estado do App (Declaradas como 'let' no escopo do módulo)
        let app, db, auth;
        let GIFT_ITEMS_COLLECTION_REF;
        let currentUserId = null;
        let selectedGiftId = null;

        // ==================================================================================
        // LISTA INICIAL DE PRESENTES PARA EDIÇÃO (ADMIN)
        // ATENÇÃO: imageUrl AGORA ACEITA UM ARRAY DE STRINGS (URLs ou sintaxe 'uploaded:')
        // ==================================================================================
        const INITIAL_GIFTS = [
            // EXEMPLO 1: Liquidificador (Usando ARRAY de URLs, a primeira é exibida no card)
            { name: "Jogo de Copos Grande", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://images.tcdn.com.br/img/img_prod/584235/jogo_6_copos_de_vidro_dubai_530ml_nadir_438983924_1_fa43134db4641243d973ca699f9d5221_20250317123318.jpg" },
            { name: "Jogo de Toalha", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://imgs.search.brave.com/EeSvXgJgX5XLVf7036swbad4YaSgv_mUtjlFwWSxmrY/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly90cnVz/c2FyZGkudnRleGFz/c2V0cy5jb20vYXJx/dWl2b3MvaWRzLzE4/MTU2NS01MDAtNTAw/P3Y9NjM4NjcwMzQ5/MDI2OTAwMDAwJndp/ZHRoPTI2OCZoZWln/aHQ9MjY4JmFzcGVj/dD10cnVl" },
            { name: "Jogo de Toalha", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://imgs.search.brave.com/7PavyIddk06UExhIuCqrCuR_GjP-KukJ9Vw9aXi2Z60/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly93d3cu/Y2FzYWFsbWVpZGEu/Y29tLmJyL21lZGlh/L2NhdGFsb2cvcHJv/ZHVjdC83LzkvNzkw/OTMwMTYwMDc2Ml8w/MjAyNTA2MjAxODAz/ODE1MC5qcGc_b3B0/aW1pemU9bWVkaXVt/JmZpdD1ib3VuZHMm/aGVpZ2h0PTM2MCZ3/aWR0aD00MDA" },
            { name: "Jogo de Toalha", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://imgs.search.brave.com/7PavyIddk06UExhIuCqrCuR_GjP-KukJ9Vw9aXi2Z60/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly93d3cu/Y2FzYWFsbWVpZGEu/Y29tLmJyL21lZGlh/L2NhdGFsb2cvcHJv/ZHVjdC83LzkvNzkw/OTMwMTYwMDc2Ml8w/MjAyNTA2MjAxODAz/ODE1MC5qcGc_b3B0/aW1pemU9bWVkaXVt/JmZpdD1ib3VuZHMm/aGVpZ2h0PTM2MCZ3/aWR0aD00MDA" },
            { name: "Frigideiras Anti-Aderente (Conjunto)", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://imgs.search.brave.com/FTIIYPuVP5PQfBXsLwDQ4YYrdkWHbPDmh_6mxxzWZ_w/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly93d3cu/dW5pdmVyc29kb2xh/ci5jb20uYnIvaW1n/LzIwMjAvMDEvcHJv/ZHV0by82OTg0LzIw/MTk4NjYwLTg4Lmpw/Zz9pbXM9Zml0LWlu/LzEyMTB4" },
            { name: "Tábua de Passar Roupas", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://imgs.search.brave.com/wc099psjJhehjmMnKnVZElxHCZ1p18LQNRlV_0myrdM/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly9odHRw/Mi5tbHN0YXRpYy5j/b20vRF9RX05QXzJY/XzYwMjczOC1NTEI4/NTM2NjI3MTI0NV8w/NTIwMjUtRS10YWJ1/YS1kZS1wYXNzYXIt/cm91cGEtdGVjaWRv/LXRlcm1pY28tMi1y/ZWd1bGFnZW5zLXBy/b21vY28ud2VicA" },
            { name: "Jogo de Talheres Inox-Alumínio", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://imgs.search.brave.com/lcn_41MHHOwOhTYKoSOoBxwKRsKj21E4emohZXF_0o4/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly9odHRw/Mi5tbHN0YXRpYy5j/b20vRF9RX05QXzJY/XzkxNTMxMy1NTEI1/MTYwNjUwOTkyOV8w/OTIwMjItRS1mYXF1/ZWlyby1seW9uLWNv/bS0yNC1wZWNhcy1l/bS1hY28taW5veC1i/cmlub3gud2VicA" },
            { name: "Panela de Arroz Elétrica", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://imgs.search.brave.com/ClaiSfUTzR8IObmHzrmn6guPzAKtnzb6BYePHVemapo/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly9odHRw/Mi5tbHN0YXRpYy5j/b20vRF9RX05QXzJY/XzY2OTcyNC1NTEE4/MjY1NDE5MTExNl8w/MzIwMjUtVi53ZWJw" },
            { name: "Liquidificador", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://imgs.search.brave.com/MoJu8MjMstIEh_ho-3GR4oGJpZwScQqUdqIHAbbxjGk/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly9odHRw/Mi5tbHN0YXRpYy5j/b20vRF9RX05QXzJY/XzkyNDI5MS1NTEI5/NDM4MDA5MDAzOV8x/MDIwMjUtVi53ZWJw" },
            { name: "Batedeira", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://imgs.search.brave.com/LOoccZsVAdrjY6XgV1D4PBfv93F5yKsRbqbwsMHZsoI/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly90ZWxo/YW5vcnRlLnZ0ZXhh/c3NldHMuY29tL2Fy/cXVpdm9zL2lkcy8x/MjQ5NjA4L01vbmRp/YWwuanBnP3Y9NjM4/MjA1NTY2OTg1MTMw/MDAw" },
            { name: "Jogo de Cama 4 peças", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://imgs.search.brave.com/rASjG9lwKXv57JfW0ooalgJ3A8zN-2EKAZ5NJYyPDH4/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly9tLm1l/ZGlhLWFtYXpvbi5j/b20vaW1hZ2VzL0kv/MzFUZ2t5SEozYUwu/anBn" },
            { name: "Jogo de Cama 4 peças", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://imgs.search.brave.com/ObKlsJTiLJB3eNKaCCiRArs3ELCREPKOIelaqGLGKgg/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly9tLm1l/ZGlhLWFtYXpvbi5j/b20vaW1hZ2VzL0kv/NDFZT0hqYk5yYUwu/anBn" },
            { name: "Jogo de Cama 4 peças", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://imgs.search.brave.com/BeKvnyFow50rXq0cbi-UpbOxO9FBhD-NbyBOQx2A4K4/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly9odHRw/Mi5tbHN0YXRpYy5j/b20vRF9RX05QXzJY/Xzg0MTI2My1NTEI3/MDU0MjMzODM0OV8w/NzIwMjMtRS1qb2dv/LWRlLWxlbmNvbC1x/dWVlbi00LXBlY2Fz/LXBvbnRvLXBhbGl0/by1hbGdvZG8tMjAw/LWZpb3Mud2VicA" },
            { name: "Conjunto 2 Travesseiros", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://imgs.search.brave.com/btoTIjqEqFREmCFbTpUOwXXJQRDWd_e6am8u2pSeHrY/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly9pbWFn/ZXMtcHJvZC5tbWFy/dGFuLmNvbS5ici8z/ODB4MzgwL3BuZy9w/cm9kdWN0cy9waG90/b3Mvc3RpbGwvYmRr/aXQycGNuY2ZrZnUt/MTUzNnB4LTE2NjI0/ODU4NTkyNzIucG5n" },
            { name: "Edredom Casal Padrão", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://imgs.search.brave.com/N2W2AaHXpxgr7rEfhQMPisLWiKUOF_z0djLCg3HKUe8/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly9odHRw/Mi5tbHN0YXRpYy5j/b20vRF9RX05QXzJY/XzgyOTQzNy1NTEE4/MTg4ODQ4NjYyOF8w/MTIwMjUtRS53ZWJw" },
            { name: "Lixeira Inox 3 Litros", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://imgs.search.brave.com/TUxUjtBcVeAbCBgWdXteyKOdv2HG616ziXdbM_ed9Y0/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly9tLm1l/ZGlhLWFtYXpvbi5j/b20vaW1hZ2VzL0kv/NTFPenZ1N0pvR0wu/anBn" },
            { name: "Lixeira Inox 5 Litros", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://imgs.search.brave.com/TUxUjtBcVeAbCBgWdXteyKOdv2HG616ziXdbM_ed9Y0/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly9tLm1l/ZGlhLWFtYXpvbi5j/b20vaW1hZ2VzL0kv/NTFPenZ1N0pvR0wu/anBn" },
            { name: "Conjunto de Sobremesa", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://imgs.search.brave.com/FHXxAIsdTSK2L81AR1mmeqxlGdI1QP82nVb5wNgJW9I/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly9odHRw/Mi5tbHN0YXRpYy5j/b20vRF9OUV9OUF84/NTYwMTAtTUxCNTI4/OTQwMjIzODFfMTIy/MDIyLVcud2VicA" },
            { name: "Conjunto de Assadeira", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://imgs.search.brave.com/4DCgtaVJZXn5a1VcGl9iCIkVfFKeVau4caYM1Bg36h4/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly9odHRw/Mi5tbHN0YXRpYy5j/b20vRF9OUV9OUF83/MjQ3OTMtTUxCNDg5/NjY0MDA2NjBfMDEy/MDIyLVcud2VicA" },
            { name: "Processador Elétrico", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://carrefourbr.vtexassets.com/arquivos/ids/186864085/image-0.jpg?v=638775912648730000" },
            { name: "Lasanheira Grande com Tampa", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://m.media-amazon.com/images/I/41sSFKPZtzL._AC_UF894,1000_QL80_.jpg" },
            { name: "Mop de Limpeza", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://diafer.vtexassets.com/arquivos/ids/173749-800-auto?v=637256670432830000&width=800&height=auto&aspect=true" },
            { name: "Churrasqueira Elétrica", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://archives.lojasnossolar.com.br/images/nossolar/produtos/4247/171717_171634_P1000.jpg" },
            { name: "Torradeira Elétrica", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://jcsbrasil.vteximg.com.br/arquivos/ids/205091-1000-1000/OTOR650.1.jpg?v=637992789832730000" },
            { name: "Jogo de Cabides + Garrafa de Café", claimed: false, claimantName: "", claimantId: "", imageUrl: ["https://goianita.vteximg.com.br/arquivos/ids/159162-800-800/Jogo-Cabides-6-Pecas---Sanremo.jpg?v=638943288636400000", "https://images.tcdn.com.br/img/img_prod/1177255/garrafa_nordica_preta_1l_38525_1_252e1029d0351c079218274929f0b09d.png"] },
            { name: "Jogo de Taça", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://m.media-amazon.com/images/I/61CyifBAeWL._AC_UF894,1000_QL80_.jpg" },
            { name: "Jogo de Colheres para Cozinha", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://imgs.search.brave.com/OV9dGQ6FGyTMlbH525QZ-7qMf58e2G1zXng_OJYVKiY/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly9pbWcu/b2x4LmNvbS5ici9p/bWFnZXMvNjEvNjE2/NDU5MjQ2MzkzNDE3/LndlYnA" },
            { name: "Jarra de Vidro + Potes Plásticos", claimed: false, claimantName: "", claimantId: "", imageUrl: ["https://imgs.search.brave.com/KSW0qwwb12sXMbqBb5rm0qRb7O1Tct9Xw1sFJksj2W0/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly9jYXNh/ZnJlaXRhczIudnRl/eGltZy5jb20uYnIv/YXJxdWl2b3MvaWRz/LzI4Mjg1OS00OTAt/NDkwLzI2NjEwMjIw/MDAwMDEtamFycmEt/dmlkcm8tdGFtcGEt/cGxhc3RpY2EtMS05/bC1kYzY1MjAwLWRj/YXNhLS0zLS5qcGc_/dj02Mzg4NTY3MDk1/Njg0NzAwMDA", 
            "https://imgs.search.brave.com/3vhalYsSJfLYPNYkdrPhyIIj4yZlAxlPgQ1iTYchpAM/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly93d3cu/bG9qYXBsYXN0aWNv/c3NhbnRhbmEuY29t/LmJyL3B1YmxpYy9w/cm9kdXRvcy8yMjAv/Njg3NS1raXQtcHJh/dGlrby1zYW5jbGlj/ay02LXVuLXBvdGVz/LTEtdW4tcG90ZS0y/LTUtbC0xLXVuLXBv/dGUtMS03LWwtNC11/bi1wb3Rlcy0yODAt/bWwuanBn"] },
            { name: "Kit 3 Potes Herméticos de Vidro", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://imgs.search.brave.com/XFXCRZ0-BQ1EfJ3yPnc-tuhAhW3W0mFAe8bvz4QZgJo/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly9odHRw/Mi5tbHN0YXRpYy5j/b20vRF9RX05QXzJY/XzY2ODQ5Ny1NTEE5/NDk0ODEyNjQxMF8x/MDIwMjUtRS53ZWJw" },
            { name: "Kit Limpeza (Balde + Vassoura + Rodo + 2 Panos de Chão)", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://xg1e7cnw4i.execute-api.us-east-1.amazonaws.com/image/wanderson/image/catalog/product/fit-in/500x500/60047.png" },
            { name: "Azeiteiro Spray + Petisqueiro", claimed: false, claimantName: "", claimantId: "", imageUrl: ["https://www.moinhoatacadista.com.br/image/cache/data/Produtos/GA/Galheteiro-de-vidro-100ml-spray-azeite-COR-NAO-DEFINIDA-DF201359-1-700x700.jpg.webp", 
            "https://i0.wp.com/vidrodecor.com.br/wp-content/uploads/2023/12/202311031635196929petisqueira-redonda-1.jpeg?fit=1051%2C927&ssl=1"] },
            { name: "Tábua de Vidro + 6 Panos de Prato", claimed: false, claimantName: "", claimantId: "", imageUrl: ["https://http2.mlstatic.com/D_NQ_NP_698248-MLB86879499704_072025-O-tabua-de-vidro-temperado-corte-gourmet-carne-legumes-atacado.webp", 
            "https://images.tcdn.com.br/img/img_prod/548599/kit_pano_de_pratos_com_barrado_8_pecas_paola_3271_3_a892d4903b301be2c82e785bc69292a0_20240226132616.jpg"] },
            { name: "3 Tapetes de Banheiro + Porta Detergente", claimed: false, claimantName: "", claimantId: "", imageUrl: ["https://imgs.search.brave.com/cwJaxfaRiBtagkqPOi8jizpkIk4iwOa9pyMHIGdtLbg/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly9odHRw/Mi5tbHN0YXRpYy5j/b20vRF9RX05QXzJY/Xzk3MjQ4My1NTEE4/MDc5MjM2ODI1Nl8x/MTIwMjQtRS53ZWJw", 
            "https://a-static.mlcdn.com.br/470x352/dispenser-pump-porta-detergente-e-esponja-de-pia-cozinha-mb-plasticos/oliststore/mglz3m2yrap6h7zd/ac9cbe303eb319490af13281dc2b2565.jpeg"] },
            { name: "Cesto de Bambu para Roupas", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://m.media-amazon.com/images/I/61COAw6yGvL._AC_UF894,1000_QL80_.jpg" },
            { name: "Escorredor de Arroz + Escorredor de Macarrão Aço Inox", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://m.media-amazon.com/images/I/61h9WmXAPPL._AC_UF894,1000_QL80_.jpg" },
            { name: "Jogo de Prato", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://imgs.pontofrio.com.br/13352788/7xg.jpg?imwidth=1000" },
            { name: "Jogo de Café e Chá", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://www.havan.com.br/media/catalog/product/cache/73a52df140c4d19dbec2b6c485ea6a50/j/o/jogo-de-cha-biona-new-trama-blue-havan-casa_878711.jpg" },
            { name: "Panela de Pressão", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://www.havan.com.br/media/catalog/product/cache/73a52df140c4d19dbec2b6c485ea6a50/p/a/panela-de-pressao-com-visor-superior-superflon-mta-6-litros_1010058.webp" },
            { name: "Conjunto Mesa Eiffel 90cm Preta + 4 Cadeiras Dsw Eiffel Design", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSkTw0ofPAU7Kc9aV2-acENaIhLRzDpHrWu2g&s" },
            { name: "Kit Sousplat", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://images.yampi.me/assets/stores/lindacasa/uploads/images/kit-6pcs-jogo-americano-redondo-suplat-sousplat-mesa-posta-verde-6183c7f083bc8-medium.jpg" },
            { name: "Kit Saleiro e Açucareiro Porcelana", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://down-br.img.susercontent.com/file/sg-11134201-7rcca-ltxs38qt2mfgfa" },
            { name: "Passadeira de Cozinha", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://www.ddbartesanato.com.br/cdn/shop/products/WhatsAppImage2023-04-18at10.37.43.jpg?v=1681825240" },
            { name: "Escorredor de Louças Inox", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://m.media-amazon.com/images/I/61TIzYjXs1L._AC_UF894,1000_QL80_.jpg" },
            { name: "Jogo de Facas", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://m.media-amazon.com/images/I/61PPolYwilL._AC_UF894,1000_QL80_.jpg" },
            { name: "Cortador de Legumes + Rolo de Macarrão", claimed: false, claimantName: "", claimantId: "", imageUrl: ["https://m.media-amazon.com/images/I/716eETQf4RL._AC_UF894,1000_QL80_.jpg", "https://static.bomprecomagazine.com.br/public/bomprecomagazine/imagens/produtos/rolo-para-massa-madeira-33cm-imporiente-668edcfb41829.jpg"]},
            { name: "Porta Papel Higiênico + Medidor de Xícaras", claimed: false, claimantName: "", claimantId: "", imageUrl: ["https://images.tcdn.com.br/img/img_prod/750752/porta_papel_higienico_de_chao_suporte_papeleira_cromado_arm_2643_1_c940c37706e6898f032b8adff667c5d0.jpg", "https://m.media-amazon.com/images/I/517UyE9lwdL._AC_UF894,1000_QL80_.jpg"]},
            { name: "Tábua de Churrasco + Garfo de Churrasco", claimed: false, claimantName: "", claimantId: "", imageUrl: ["https://images.tcdn.com.br/img/img_prod/769607/tabua_churrasco_em_madeira_natural_45_x_28_x_2_8_personalizada_5131_1_eb014a15f4b1524e4f922109d010c30e.jpeg", "https://lojamor.vtexassets.com/arquivos/ids/181617/003307-Garfo-para-Churrasco-Emb-2.jpg?v=638300474010470000"]},
            { name: "Pix R$ 60,00", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://transfeera.com/wp-content/uploads/2021/02/opcao-03.jpg" },
            { name: "Pix R$ 80,00", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://transfeera.com/wp-content/uploads/2021/02/opcao-03.jpg" },
            { name: "Pix R$ 100,00", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://transfeera.com/wp-content/uploads/2021/02/opcao-03.jpg" },
            { name: "Pix R$ 70,00", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://transfeera.com/wp-content/uploads/2021/02/opcao-03.jpg" },
            { name: "Balança Digital + Amassador de Batata Alumínio-Inox", claimed: false, claimantName: "", claimantId: "", imageUrl: ["https://acdn-us.mitiendanube.com/stores/004/823/488/products/14059-1-b3108f30a762e7572717210941712539-1024-1024.jpg", 
            "https://multibar.vtexassets.com/arquivos/ids/556973/Espremedor_de_Batatas_e_Legumes_Hrcules_em_Ao_Inox_163310.jpg?v=638895945497370000"] },
            { name: "Forma de Silicone Redonda + Kit Tigela Redondo de Vidro", claimed: false, claimantName: "", claimantId: "", imageUrl: ["https://http2.mlstatic.com/D_Q_NP_2X_780961-MLB78562416014_082024-T-kit-com-5-pirex-tigela-pote-de-vidro-com-tampa-plastica.webp", "https://images.tcdn.com.br/img/img_prod/836117/forma_pudim_silicone_25cm_mimo_6571_1_ac107eb3f810bc07514d4fc7d735d84b.png"] },
            { name: "Terrina Média", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://ocapi.nadir.com.br/on/demandware.static/-/Sites-nadir-main-catalog/default/dw85b81c03/nadir/large/GD16456719N_a_700px.webp" },
            { name: "Geladeira (Exclusivo Vitor de Oliveira)", claimed: false, claimantName: "", claimantId: "", imageUrl: "https://www.havan.com.br/media/catalog/product/cache/73a52df140c4d19dbec2b6c485ea6a50/r/e/refrigerador-geladeira-consul-frost-free-duplex-386l-platinum_830072_1.jpg" },
        ];
        
        // --- Funções de UI ---

        /**
         * Renderiza um único cartão de presente.
         * @param {Object} gift - Objeto do presente com nome, claimed, claimantName, e id.
         */
        function renderGiftCard(gift) {
            const isClaimed = gift.claimed;
            
            // ATUALIZAÇÃO CRÍTICA 1: Obtém a primeira URL da lista de imageUrls para o cartão.
            const imageUrls = Array.isArray(gift.imageUrl) ? gift.imageUrl : (gift.imageUrl ? [gift.imageUrl] : []);
            
            // GARANTIA: Usa a primeira URL válida ou um placeholder genérico
            const primaryImageUrl = imageUrls[0] || 'https://placehold.co/400x300/cccccc/333333?text=Sem+Imagem';
            
            // ATUALIZAÇÃO CRÍTICA 2: Codifica o array completo de URLs para passar ao botão.
            const imageUrlsJson = encodeURIComponent(JSON.stringify(imageUrls)); 

            // Classes e textos baseados no status. Usa a cor 'casamento' para RESERVADO.
            const statusClass = isClaimed ? 'bg-casamento-200 text-casamento-800' : 'bg-green-200 text-green-800';
            const statusText = isClaimed ? 'Reservado' : 'Disponível';
            
            // ATUALIZAÇÃO: O botão e o texto de ação agora sempre dizem "Reservado" se for true.
            const actionText = isClaimed ? 'Reservado' : 'Escolher Item';
            // Cor do botão de ação. Usa a cor 'casamento' para RESERVAR.
            const buttonColor = isClaimed ? 'bg-gray-400 cursor-not-allowed' : 'bg-casamento-500 hover:bg-casamento-700 shadow-md shadow-casamento-300';

            // ATUALIZAÇÃO: Conteúdo do reclamante agora é genérico para ocultar o nome.
            const claimantInfo = isClaimed 
                ? `<p class="text-sm mt-2 text-gray-700">Este item já foi reservado.</p>`
                : `<p class="text-sm mt-2 text-gray-500">Toque para reservar seu item!</p>`;


            return `
                <div class="bg-white p-5 rounded-xl shadow-lg hover:shadow-xl transition duration-300 flex flex-col justify-between border-t-4 ${isClaimed ? 'border-casamento-500' : 'border-green-500'}">
                    
                    <!-- Imagem do Produto -->
                    <div class="mb-4 overflow-hidden rounded-lg shadow-md aspect-[4/3] bg-gray-100">
                        <!-- Usa a PRIMARY_IMAGE_URL -->
                        <img src="${primaryImageUrl}" 
                             alt="Imagem de ${gift.name}" 
                             class="w-full h-full object-cover transition duration-300 hover:scale-[1.03]"
                             onerror="this.onerror=null; this.src='https://placehold.co/400x300/cccccc/333333?text=Imagem+Indisponível';"
                        >
                    </div>

                    <div>
                        <span class="inline-block px-3 py-1 text-xs font-bold rounded-full ${statusClass} mb-3">
                            ${statusText}
                        </span>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">${gift.name}</h3>
                        ${claimantInfo}
                    </div>
                    <button data-id="${gift.id}" 
                            data-name="${gift.name}"
                            data-urls="${imageUrlsJson}"
                            ${isClaimed ? 'disabled' : ''}
                            class="claim-button w-full mt-4 px-4 py-2 text-white font-semibold rounded-lg transition duration-150 ${buttonColor}">
                        ${actionText}
                    </button>
                </div>
            `;
        }

        /**
         * Atualiza a lista de presentes no HTML.
         * @param {Array} gifts - Array de objetos de presente.
         */
        function updateGiftListUI(gifts) {
            const container = document.getElementById('gift-list-container');
            const loadingStatus = document.getElementById('loading-status');
            
            loadingStatus.classList.add('hidden'); // Esconde o status de carregamento

            if (gifts.length === 0) {
                 // SE VAZIO: Mostra uma mensagem amigável (ajuda a diagnosticar falha de inicialização)
                 container.innerHTML = `
                    <div class="col-span-full text-center p-10 bg-casamento-100 rounded-xl shadow-inner border border-casamento-300">
                        <svg class="w-10 h-10 mx-auto text-casamento-500 mb-3" fill="none" stroke="currentColor" viewBox="0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10m0-6h.01"></path></svg>
                        <p class="text-xl font-bold text-casamento-700 mb-2">Lista Vazia!</p>
                        <p class="text-gray-600">
                            Parece que os presentes não foram carregados do banco de dados. 
                            <span class="font-semibold">Por favor, verifique se você publicou as Regras de Segurança do Firestore que permitem a ESCRITA (write) para usuários autenticados.</span>
                        </p>
                    </div>
                 `;
                 return;
            }

            container.innerHTML = gifts.map(renderGiftCard).join('');

            // Adiciona listeners aos botões "Reservar Item"
            document.querySelectorAll('.claim-button:not([disabled])').forEach(button => {
                button.addEventListener('click', (e) => {
                    selectedGiftId = e.currentTarget.dataset.id;
                    const itemName = e.currentTarget.dataset.name;
                    // NOVO: Pega o JSON string das URLs
                    const imageUrlsJson = e.currentTarget.dataset.urls; 
                    openClaimModal(itemName, imageUrlsJson);
                });
            });
        }
        
        // --- Funções do Modal ---

        const claimModal = document.getElementById('claim-modal');
        const modalContent = document.getElementById('modal-content');
        const itemNamePlaceholder = document.getElementById('item-name-placeholder');
        const claimantNameInput = document.getElementById('claimant-name');
        const confirmClaimButton = document.getElementById('confirm-claim');
        const cancelClaimButton = document.getElementById('cancel-claim');
        const claimError = document.getElementById('claim-error');
        const imageGalleryContainer = document.getElementById('image-options-container'); // Referência direta
        const imageGallery = document.getElementById('image-gallery'); // Referência direta

        /**
         * Abre o modal de reivindicação, agora com opções de imagem.
         * @param {string} itemName - Nome do presente a ser reivindicado.
         * @param {string} imageUrlsJson - JSON string com todas as URLs de imagem.
         */
        function openClaimModal(itemName, imageUrlsJson) {
            itemNamePlaceholder.textContent = itemName;
            
            // NOVO: Processamento e exibição das imagens
            imageGallery.innerHTML = ''; // Limpa a galeria
            
            let imageUrls = [];
            try {
                // Decodifica e faz o parsing do JSON string das URLs
                imageUrls = JSON.parse(decodeURIComponent(imageUrlsJson));
            } catch (e) {
                console.error("Erro ao decodificar URLs:", e);
                imageUrls = []; 
            }
            
            // VERIFICAÇÃO CRÍTICA: Só exibe a galeria se houver MAIS DE UMA imagem.
            if (imageUrls.length > 1) {
                // Exibe todas as opções se houver mais de uma
                imageUrls.forEach((url, index) => {
                    // MUDANÇA: Remover classes de interação (hover, border, cursor-pointer)
                    imageGallery.innerHTML += `
                        <div class="p-1 rounded-lg"> 
                            <img src="${url}" 
                                 alt="Opção ${index + 1} de ${itemName}" 
                                 class="w-full h-auto rounded object-cover aspect-video shadow-sm"
                                 onerror="this.onerror=null; this.src='https://placehold.co/200x150/f0f0f0/333333?text=Opção+${index+1}';"
                            >
                            <!-- MUDANÇA: Removeu a mensagem "Opção X" -->
                        </div>
                    `;
                });
                // Garante que o container de opções seja visível
                imageGalleryContainer.classList.remove('hidden');
            } else {
                // Oculta o container se houver apenas uma imagem ou nenhuma
                imageGalleryContainer.classList.add('hidden');
            }


            // Tenta pré-preencher o nome do usuário se ele já reservou algo antes
            const storedName = localStorage.getItem('lastClaimantName'); 
            claimantNameInput.value = storedName || ''; 
            claimError.classList.add('hidden');
            
            claimModal.classList.remove('hidden');
            claimModal.classList.add('flex');
            // Animação de entrada
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        /**
         * Fecha o modal de reivindicação.
         */
        function closeClaimModal() {
            // Animação de saída
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                claimModal.classList.remove('flex');
                claimModal.classList.add('hidden');
                selectedGiftId = null;
            }, 300);
        }

        cancelClaimButton.addEventListener('click', closeClaimModal);
        
        // --- Funções do Firebase/Firestore ---
        
        /**
         * Popula o banco de dados com a lista inicial se estiver vazio.
         * LÓGICA REFINADA: Apenas define o marcador de inicialização após a escrita bem-sucedida de todos os presentes.
         */
        async function initializeGiftList() {
            try {
                // 1. Checa se o marcador de inicialização existe
                const docRef = doc(GIFT_ITEMS_COLLECTION_REF, 'initializer_check');
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    return;
                }

                console.log("Coleção vazia. Inicializando com presentes padrão...");

                // 2. Cria promessas para a escrita de TODOS os presentes
                const giftPromises = INITIAL_GIFTS.map(gift => {
                    const newDocRef = doc(GIFT_ITEMS_COLLECTION_REF);
                    return setDoc(newDocRef, gift);
                });
                
                // 3. Espera que TODOS os presentes sejam escritos
                await Promise.all(giftPromises); 

                // 4. Adiciona o documento marcador SOMENTE SE todos os presentes foram escritos com sucesso
                await setDoc(docRef, { initialized: true }); 

                console.log("Lista inicial de presentes adicionada com sucesso.");

            } catch (e) {
                console.error("Erro CRÍTICO ao inicializar a lista (Verifique as Regras de Escrita!):", e);
                // Exibe o erro crítico na UI para o administrador
                document.getElementById('error-text').textContent = `Erro CRÍTICO na Inicialização (Provavelmente permissão de ESCRITA). Erro: ${e.message}`;
                document.getElementById('error-message').classList.remove('hidden');
                throw e; // Re-lança para notificar o caller
            }
        }

        /**
         * Lógica de reivindicação de presente usando Transação para garantir atomicidade.
         */
        confirmClaimButton.addEventListener('click', async () => {
            const claimantName = claimantNameInput.value.trim();
            claimError.classList.add('hidden');

            if (!claimantName) {
                claimError.textContent = 'Por favor, insira seu nome para reservar.';
                claimError.classList.remove('hidden');
                return;
            }
            
            if (!selectedGiftId) {
                claimError.textContent = 'Erro interno: Item não selecionado.';
                claimError.classList.remove('hidden');
                return;
            }

            // Salva o nome do usuário no local storage para auto-preenchimento
            localStorage.setItem('lastClaimantName', claimantName);
            
            // Desativa o botão para evitar cliques duplos
            confirmClaimButton.disabled = true;
            confirmClaimButton.textContent = 'Reservando...';
            
            const giftRef = doc(GIFT_ITEMS_COLLECTION_REF, selectedGiftId);

            try {
                // Usa uma transação para garantir que a atualização só ocorra
                await runTransaction(db, async (transaction) => {
                    const giftDoc = await transaction.get(giftRef);

                    if (!giftDoc.exists()) {
                        throw new Error("O presente não existe mais.");
                    }

                    const data = giftDoc.data();

                    if (data.claimed) {
                        // Se já estiver reivindicado, cancela a transação e avisa o usuário
                        throw new Error(`Este presente já foi reservado por ${data.claimantName}!`);
                    }

                    // Se estiver disponível, reivindica
                    transaction.update(giftRef, {
                        claimed: true,
                        claimantName: claimantName,
                        claimantId: currentUserId,
                    });
                });

                closeClaimModal();
                // IMPORTANTE: Forçar atualização da lista imediatamente após a reserva
                await fetchGiftChanges(); 
                

            } catch (e) {
                console.error("Erro ao reivindicar presente:", e);
                // Exibe a mensagem de erro da transação (incluindo "já reivindicado")
                claimError.textContent = e.message.includes('reservado') 
                    ? e.message 
                    : 'Falha ao reservar o item. Tente novamente.';
                claimError.classList.remove('hidden');
            } finally {
                confirmClaimButton.disabled = false;
                confirmClaimButton.textContent = 'Confirmar Reserva';
            }
        });

        /**
         * Função para exibir erro de configuração (apenas como fallback)
         */
        function showConfigError() {
            document.getElementById('loading-status').textContent = 'Erro: Falha na configuração do Firebase.';
            console.error('Firebase config check failed.');
            document.getElementById('error-text').textContent = 'Erro de inicialização: Verifique suas chaves de configuração no código-fonte.';
            document.getElementById('error-message').classList.remove('hidden');
        }

        // NOVO: Função para buscar os presentes (fetch único)
        async function fetchGiftChanges() {
            try {
                // Usa getDocs para uma leitura única, economizando custos
                const snapshot = await getDocs(GIFT_ITEMS_COLLECTION_REF);
                
                const gifts = [];
                snapshot.forEach((doc) => {
                    // Ignora o documento de inicialização/marcador
                    if (doc.id !== 'initializer_check') {
                        gifts.push({ id: doc.id, ...doc.data() });
                    }
                });

                // Ordena alfabeticamente
                gifts.sort((a, b) => a.name.localeCompare(b.name));

                updateGiftListUI(gifts);
            } catch (error) {
                console.error("Erro ao buscar dados do Firestore:", error);
                
                let userFriendlyMessage = `Erro de sincronização: ${error.message}`;

                // Adição para verificar erro de permissão do Firestore (Importante para o usuário)
                if (error.code === 'permission-denied') {
                     userFriendlyMessage = `Erro Crítico (Permission Denied): Por favor, verifique se as Regras de Segurança do Firestore (chadepanela-eeb39) permitem a LEITURA ('allow read: if request.auth != null;').`;
                }

                document.getElementById('loading-status').classList.add('hidden');
                document.getElementById('error-text').textContent = userFriendlyMessage;
                document.getElementById('error-message').classList.remove('hidden');
            }
        }
        
        // NOVO: Função para iniciar o Polling a cada 15 segundos
        function startPolling() {
            fetchGiftChanges(); // Primeira busca
            // Busca a lista a cada 15 segundos (15000ms) - Polling
            setInterval(fetchGiftChanges, 15000); 
        }

        /**
         * Função principal de inicialização do aplicativo.
         */
        async function setupApp() {
            // 1. Inicializa o Firebase
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Referência à coleção pública de presentes
            GIFT_ITEMS_COLLECTION_REF = collection(db, 'artifacts', appId, 'public', 'data', 'gift_items');
            
            // 2. Tenta Autenticar Anonimamente
            try {
                const userCredential = await signInAnonymously(auth);
                const user = userCredential.user;
                
                // Se a autenticação for bem-sucedida, continua a inicialização
                currentUserId = user.uid;
                document.getElementById('user-id-display').textContent = user.uid;
                
                // 3. Inicializa e Sincroniza a Lista
                await initializeGiftList();
                startPolling(); // Inicia a busca programada (Polling)
                
            } catch (error) {
                console.error("Erro Crítico de Autenticação:", error);
                
                let userFriendlyMessage = `Erro de autenticação: ${error.message}`;

                // Adiciona uma dica sobre a causa mais comum de falha no login anônimo
                if (error.code === 'auth/configuration-not-found' || error.code === 'auth/operation-not-allowed') {
                    userFriendlyMessage = `Erro Crítico (Auth): Por favor, ative o provedor 'Anonymous' no seu Console do Firebase (Authentication > Sign-in method).`;
                }

                document.getElementById('loading-status').classList.add('hidden');
                document.getElementById('error-text').textContent = userFriendlyMessage;
                document.getElementById('error-message').classList.remove('hidden');
            }
        }

        // --- Checagem e Inicialização Principal ---
        if (!firebaseConfig || !firebaseConfig.projectId) {
            showConfigError();
        } else {
            setupApp();
        }
    </script>

</body>
</html>